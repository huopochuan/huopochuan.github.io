


<!DOCTYPE html>
<html>
  <head>
    
<meta charset="utf-8" >

<title>Android App Bundles解析 | 琥珀川</title>
<meta name="description" content="大道至简 知易行难">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.0/animate.min.css">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://huopochuan.github.io//favicon.ico?v=1571131709348">
<link rel="stylesheet" href="https://huopochuan.github.io//styles/main.css">


  
    <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css" />
  

  


<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>



  </head>
  <body>
    <div id="app" class="main">
      <div class="site-header-container">
  <div class="site-header">
    <div class="left">
      <a href="https://huopochuan.github.io/">
        <img class="avatar" src="https://huopochuan.github.io//images/avatar.png?v=1571131709348" alt="" width="32px" height="32px">
      </a>
      <a href="https://huopochuan.github.io/">
        <h1 class="site-title">琥珀川</h1>
      </a>
    </div>
    <div class="right">
      <transition name="fade">
        <i class="icon" :class="{ 'icon-close-outline': menuVisible, 'icon-menu-outline': !menuVisible }" @click="menuVisible = !menuVisible"></i>
      </transition>
    </div>
  </div>
</div>

<transition name="fade">
  <div class="menu-container" style="display: none;" v-show="menuVisible">
    <div class="menu-list">
      
        
          <a href="/" class="menu purple-link">
            首页
          </a>
        
      
        
          <a href="/archives" class="menu purple-link">
            归档
          </a>
        
      
        
          <a href="/tags" class="menu purple-link">
            标签
          </a>
        
      
        
          <a href="/post/about" class="menu purple-link">
            你好 世界
          </a>
        
      
    </div>
  </div>
</transition>


      <div class="content-container">
        <div class="post-detail">
          
          <h2 class="post-title">Android App Bundles解析</h2>
          <div class="post-info post-detail-info">
            <span><i class="icon-calendar-outline"></i> 2019-09-18</span>
            
          </div>



  
          <p class="show-toc-btn" id="show-toc-btn" onclick="showToc();" style="display:none">
          <span class="btn-bg"></span>
          <span class="btn-text">文章导航</span>
          </p>
  <div id="toc-article" class="toc-article">
      <span id="toc-close" class="toc-close" title="隐藏导航" onclick="showBtn();">×</span>
    <strong class="toc-title">文章目录</strong>
           <ul class="markdownIt-TOC">
<li><a href="#%E4%BB%80%E4%B9%88%E6%98%AFandroid-app-bundles">什么是Android App Bundles</a></li>
<li><a href="#%E5%8A%A8%E6%80%81%E4%BA%A4%E4%BB%98google-play-dynamic-delivery">动态交付（Google Play Dynamic Delivery）</a></li>
<li><a href="#google-play-%E5%9C%A8%E4%B8%8B%E8%BD%BD%E4%B8%8E%E6%9B%B4%E6%96%B0apk%E6%98%AF%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E6%8C%89%E9%9C%80%E6%A8%A1%E5%9D%97%E4%B8%8E%E5%9F%BA%E6%9C%AC%E6%A8%A1%E5%9D%97%E7%9A%84%E5%91%A2">Google play 在下载与更新APK是如何处理按需模块与基本模块的呢？</a></li>
<li><a href="#bundletool">Bundletool</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8-android-app-bundles%E9%A1%B9%E7%9B%AE%E4%BE%9D%E8%B5%96%E7%BB%93%E6%9E%84">使用 Android App bundles项目依赖结构</a></li>
<li><a href="#aab-%E6%8B%86%E5%88%86%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9">AAB 拆分注意事项</a></li>
<li><a href="#res%E8%B5%84%E6%BA%90%E7%BB%93%E6%9E%84">res资源结构</a></li>
<li><a href="#%E7%B1%BB%E6%96%87%E4%BB%B6%E6%9E%84%E5%BB%BA%E8%A7%84%E5%88%99">类文件构建规则</a></li>
<li><a href="#%E6%B7%B7%E6%B7%86%E8%A7%84%E5%88%99">混淆规则</a></li>
<li><a href="#%E5%8E%9F%E7%90%86">原理</a></li>
<li><a href="#%E9%97%AE%E9%A2%98%E7%82%B9">问题点</a></li>
<li><a href="#%E5%B1%95%E6%9C%9B">展望</a></li>
<li><a href="#%E5%8F%82%E8%80%83">参考</a></li>
</ul>

         </div>
   <script type="text/javascript">
  function showToc(){
    var toc_article = document.getElementById("toc-article");
    var show_toc_btn = document.getElementById("show-toc-btn");
    toc_article.setAttribute("style","display:block");
    show_toc_btn.setAttribute("style","display:none");
    };
  function showBtn(){
    var toc_article = document.getElementById("toc-article");
    var show_toc_btn = document.getElementById("show-toc-btn");
    toc_article.setAttribute("style","display:none");
    show_toc_btn.setAttribute("style","display:block");
    };
   </script>
    


          <div class="post-content">
            <h1 id="什么是android-app-bundles">什么是Android App Bundles</h1>
<p>Android App Bundles是 Android 新推出的一种官方发布格式(.aab)。通过使用Android App Bundle你可以减少应用的包大小，从而提升安装成功率并减少卸载量。<br>
<img src="https://developer.android.com/images/app-bundle/aab_format-2x.png" alt="APP bundle文件格式"><br>
<img src="https://s2.ax1x.com/2019/10/13/uxKNin.jpg" alt="Android App Bundles 文件格式"><br>
从上图可以看出App Bundles文件格式，他包含Base Moudle和我们拆分的Feature Module文件夹，签名文件和其他的配置文件。每个Moudle文件夹内包含dex，manifest，res，和一个resources.pb文件。和APK的文件结构基本保持一致。base module和每个Dynamic Feature Module都包含各自的代码和资源，它们组成了原先apk文件的内容。<br>
Google Play就是基于对aab文件处理，将App Bundle在多个维度进行拆分，在资源维度，ABI维度和Language维度进行了拆分，你只要按需组装你的Apk然后安装即可。如果你的手机是一个x86，xhdpi的手机，你在google play应用市场下载apk时，gogle play会获取手机的信息，然后根据App Bundle会帮你拼装好一个apk，这个apk的资源只有xhdpi的，而且so库只有x86，其他无关的都会剔除。从而减少了apk的大小。<br>
<img src="https://yqfile.alicdn.com/a3da66b4772bee3e696da8772410c32ee53c723e.gif" alt="APP bundle原理"></p>
<h1 id="动态交付google-play-dynamic-delivery">动态交付（Google Play Dynamic Delivery）</h1>
<p><img src="https://developer.android.com/images/app-bundle/apk_splits_tree-2x.png" alt=""><br>
通过Android App bundles可以基于维度的选择减少apk大小，另外Google Play还提供了动态交付功能。Android App Bundle 支持模块化，通过Dynamic Delivery with split APKs，将一个apk拆分成多个apk，按需加载（包括加载C/C++ libraries）</p>
<ol>
<li>Base Apk（基本apk）:此APK中包含了所有其他拆分APK都可以访问的代码和资源，并提供应用的基本功能。当用户请求下载您的应用时，会首先下载并安装该APK。</li>
<li>Configuration APKs<br>
native libraries 和适配当前手机屏幕分辨率的资源</li>
<li>Dynamic feature APKs<br>
每个动态功能 APK 都包含您应用中的某项功能的代码和资源，并且您使用动态功能模块对相应功能进行了模块化处理。<br>
对于上述三个类型apk</li>
</ol>
<p>启用改功能需要我们在base module中集成Play Core Library。用户在Google Play下载一个通过Android App Bundle 方式开发的应用时，只会下载base module对应的apk文件，Dynamic Feature Module对应的apk文件会在运行时按需下载。Play Core Library用来在App运行时请求下载Dynamic Feature Module对应的apk。可以查看<a href="https://developer.android.com/guide/app-bundle/playcore">Play Core API 使用</a></p>
<h1 id="google-play-在下载与更新apk是如何处理按需模块与基本模块的呢">Google play 在下载与更新APK是如何处理按需模块与基本模块的呢？</h1>
<p><a href="https://codelabs.developers.google.com/codelabs/on-demand-dynamic-delivery/index.html#7">https://codelabs.developers.google.com/codelabs/on-demand-dynamic-delivery/index.html#7</a></p>
<blockquote>
<p>Note:<br>
To test the download of an on-demand module it's not enough to update the application on the device because the update operation also updates all the on-demand modules that are already installed.<br>
To test the download of the module, you have to uninstall the application and install it again. In this way the on-demand modules are not going to be installed.</p>
</blockquote>
<p>可以看出Google Play的下载与更新APK的逻辑很简单，每次下载时都会只下载非按需加载模块，下载了基本模块之后，就可以按需加载其他模块。如果之后我升级了APK，按需在加载模块是怎么处理的呢？Google Play会同时为我们更新。这样我们无需为按需加载模块做版本兼容处理。Base Moudle与 Dynamic Moudle版本永远都会是保存一直的。因为Google Play都是基于一个AAB文件构建出APK交付给用户。</p>
<h1 id="bundletool">Bundletool</h1>
<p>我们通过android studio 的build bundle功能生成aab格式文件，我们必须测试 Google Play 使用该 Android App Bundle 生成 APK 的情形。验证方式1：bundletool 命令行工具进行测试。验证方式2：通过 Google Play 将您的 app bundle 上传到 Play 管理中心并使用测试轨道进行测试。<br>
下面我们看看Bundletool的具体使用方式</p>
<ol>
<li>使用bundletool build-apks 命令从 app bundle 生成一组 APK</li>
</ol>
<pre><code>java -jar bundletool-all-0.10.3.jar build-apks --bundle=58WuxianClient.aab --output=my_app.apks
</code></pre>
<p><img src="https://s2.ax1x.com/2019/10/13/uxd856.jpg" alt="apks文件结构"><br>
<img src="https://s2.ax1x.com/2019/10/13/uxdkEq.jpg" alt="apks文件结构"><br>
我看查看一下apks的文件解结构，分为两个目录splits和standalones<br>
splits目录：可以看出splits就是对各个moudle的在资源维度，ABI维度和Language维度的拆分。base moudle和car moudle基于维度各自产生了apk集合。当我们使用app bundle上传到google play后，在google play安装apk时（手机android版本&gt;=21即android 5.0），google play就会在apk集合中找到和手机语言，API,分辨率相同的apk安装到手机从而减少apk大小。<br>
standalones目录：因为对于小于21的android手机是不支持多apk的模式安装的，同时也不支持按需加载，所以对于该类型的手机要生成一个APK,当然也在维度进行了拆分。每个包的大小都在58M左右。与现在的58APP相比减少了30M（30%）。</p>
<ol start="2">
<li>通过install-apks命令将 APK 部署到连接的设备（andoid 版本为5.1 OPPO R9）</li>
</ol>
<pre><code>java -jar bundletool-all-0.10.3.jar install-apks --apks=my_app.apks
</code></pre>
<p><img src="https://s2.ax1x.com/2019/10/13/uxUXpF.jpg" alt="推送到app的文件结构"><br>
从文件结构可以看出推送到手机的apk包含4个base.apk,split_config.armeabi.apk,split_config.xxhdpi.apk,split_config.zh.apk。根据手机的设备信息安装对应的apk.但是我们发现没看car.apk文件这是为什么呢？</p>
<pre><code> &lt;dist:module
        dist:instant=&quot;false&quot;
        dist:onDemand=&quot;true&quot;
        dist:title=&quot;@string/title_dynamic_feature&quot;&gt;
        &lt;dist:fusing dist:include=&quot;true&quot; /&gt;
    &lt;/dist:module&gt;
</code></pre>
<p>因为我们启用了按需加载所以安装的模块中并没有car.apk,我们需要在base moudle中使用Play Core Library用来在App运行时请求下载Dynamic Feature Module对应的apk。<br>
如果我们把上述的onDemand改为false,我们在重新安装apk,我们在查看一下apk的安装目录（为红米k20 通过android studio 无法直接查看安装目录只能通过adb命令），就会发现存在car模块对应的apk了，包含split_CarLib.apk和配置模块split_CarLib.config.xxhdpi.apk</p>
<pre><code>192:50APP wangyongchuan$ adb shell pm path com.wuba
package:/data/app/com.wuba-flDXC2tcSXaidf_VbJVuMQ==/base.apk
package:/data/app/com.wuba-flDXC2tcSXaidf_VbJVuMQ==/split_CarLib.apk
package:/data/app/com.wuba-flDXC2tcSXaidf_VbJVuMQ==/split_CarLib.config.xxhdpi.apk
package:/data/app/com.wuba-flDXC2tcSXaidf_VbJVuMQ==/split_config.armeabi.apk
package:/data/app/com.wuba-flDXC2tcSXaidf_VbJVuMQ==/split_config.xxhdpi.apk
package:/data/app/com.wuba-flDXC2tcSXaidf_VbJVuMQ==/split_config.zh.apk
</code></pre>
<ol start="3">
<li>获取当前设备的信息文件</li>
</ol>
<pre><code>java -jar bundletool-all-0.10.3.jar get-device-spec --output=device-spec.json
</code></pre>
<p>设备信息文件内容</p>
<pre><code>{
  &quot;supportedAbis&quot;: [&quot;arm64-v8a&quot;, &quot;armeabi-v7a&quot;, &quot;armeabi&quot;],
  &quot;supportedLocales&quot;: [&quot;zh-CN&quot;],
  &quot;deviceFeatures&quot;: [&quot;reqGlEsVersion=0x30000&quot;, &quot;android.hardware.audio.output&quot;, &quot;oppo.fulldiskencryption.unsupported&quot;, &quot;oppo.guard.elf.support&quot;, &quot;oppo.high.brightness.support&quot;, &quot;oppo.hw.manufacturer.mtk&quot;, &quot;oppo.inexact.alarm&quot;, &quot;oppo.leather.proximity.sensor.support&quot;, &quot;oppo.memory.auto.clean&quot;, &quot;oppo.memory.auto.deep.clean&quot;, &quot;oppo.multi.touch.camera.support&quot;, &quot;oppo.ota.twokey.not.support&quot;, &quot;oppo.otg.connection.menu.support&quot;, &quot;oppo.quick.shot.support&quot;, &quot;oppo.screen.hovering.support&quot;, &quot;oppo.soundeffect.support&quot;, &quot;oppo.support.single.partition&quot;, &quot;oppo.sw.solution.device&quot;, &quot;oppo.tp.limit.support&quot;, &quot;oppo.volte.support&quot;],
  &quot;screenDensity&quot;: 480,
  &quot;sdkVersion&quot;: 22
}
</code></pre>
<h1 id="使用-android-app-bundles项目依赖结构">使用 Android App bundles项目依赖结构</h1>
<p><img src="http://chuantu.xyz/t6/702/1570674856x2073530529.jpg" alt=""><br>
从上图可以看出，使用AAB,项目的依赖结构发生了变化。有base和feature0模块，在base中无法直接引用feature模块的类，feature模块可以直接依赖base模块。<br>
应用模块化带来的好处：</p>
<ol>
<li>并行开发：将应用拆分不同的模块，各个团队开发自己负责的模块。</li>
<li>加快编译时间：Gradle 的并行项目执行优化，编译系统就能够并行地编译多个模块，从而显著减少编译时间。</li>
<li>动态模块按需加载减少apk大小。</li>
</ol>
<h1 id="aab-拆分注意事项">AAB 拆分注意事项</h1>
<ol>
<li>dynamic-feature moudle引用base modle资源时，不能直接使用R.drawdble	 需要使用 [base moudle packagename].R.drawdble的方式</li>
<li>dynamic-feature 项目名称不能以数据开头如58CarLib	需要改写为CarLib</li>
<li>java.io.IOException: Cannot find PROCESSED_RES output for Main{type=MAIN, fullName=flavor1Debug, filters=[], versionCode=-1, versionName=null}异常	需要注释掉build.gradle的splite {abi{}}</li>
<li>basemoude不可以访问feature moudle中的id	<br>
CarLib中arssc文件中R.id.title_filter_btn中的值为0x7e0704d8<br>
BaseMoude中arssc文件中R.id.title_filter_btn中的值为0x7f090d85<br>
因为feature与baseMoude都有各自的arsc文件，虽然属性名称一直但是id值是不一致的，所以basemoude中涉及访问feature moudle的id值都需要修改</li>
<li>动态模块配置制定title 必须通过如下方式配置 dist:title=&quot;@string/title_dynamic_feature&quot; 不能直接编写字符串 并且改字符串必须写在base moudle中。</li>
</ol>
<h1 id="res资源结构">res资源结构</h1>
<figure data-type="image" tabindex="1"><img src="http://chuantu.xyz/t6/702/1570685613x3661913030.png" alt=""></figure>
<p>每个feature moudle都会生成自己独立的arsc文件，同时为了不与其他moudle产生冲突，每个moudle其资源id的头两位都是有差异的。从图中可以看出car的feature moudle的资源id是以0x7e开始而不是0x7f。<br>
因此在资源id使用时需要注意一下几点：</p>
<ol>
<li>dynamic-feature moudle引用base modle资源时，不能直接使用R.drawdble需要使用 [base moudle packagename].R.drawdble的方式</li>
<li>basemoude不可以访问feature moudle中的id	<br>
CarLib中arssc文件中R.id.title_filter_btn中的值为0x7e0704d8<br>
BaseMoude中arssc文件中R.id.title_filter_btn中的值为0x7f090d85<br>
因为feature与baseMoude都有各自的arsc文件，虽然属性名称一直但是id值是不一致的，所以basemoude中涉及访问feature moudle的id值都需要修改。</li>
</ol>
<h1 id="类文件构建规则">类文件构建规则</h1>
<h1 id="混淆规则">混淆规则</h1>
<h1 id="原理">原理</h1>
<p>资源加载 与 类加载机制</p>
<h1 id="问题点">问题点</h1>
<h1 id="展望">展望</h1>
<p>App Bundles 方案在减少APK大小方面，就有很大的优势。但是App Bundles方案依托与Google Play应该才能做到业务模块的按需加载。但是目前爱奇艺开源了<a href="https://github.com/iqiyi/Qigsaw">Qigsaw框架</a>,自己实现了一套类型Google Play的方案，同时保持API的使用与Google Play保持一致，这样就可以做到国内与国外场景的自由切换。</p>
<h1 id="参考">参考</h1>
<p>https://juejin.im/entry/5b1e233ef265da6e0d7a33b3<br>
https://blog.csdn.net/u010479969/article/details/81261<br>
https://agehua.github.io/2019/03/27/Android-APP-Bundles-Introduction/<br>
https://zhuanlan.zhihu.com/p/34346219<br>
https://developer.android.com/guide/app-bundle/<br>
https://developer.android.com/studio/projects/dynamic-delivery<br>
https://developer.android.com/studio/command-line/bundletool<br>
https://developer.android.com/guide/app-bundle/playcore<br>
https://github.com/android/app-bundle-samples/tree/master/DynamicFeatures<br>
https://zhuanlan.zhihu.com/p/83411322<br>
https://codelabs.developers.google.com/codelabs/on-demand-dynamic-delivery/</p>

          </div>
        </div>

        
          <div class="next-post">
            <a class="purple-link" href="https://huopochuan.github.io//post/orm-kuang-jia-diao-yan">
              <h3 class="post-title">
                下一篇：Android端ORM框架调研与应用
              </h3>
            </a>
          </div>
          
      </div>

      
        
          <div id="gitalk-container"></div>
        

        
      

      <div class="site-footer">
  <div class="slogan">大道至简 知易行难</div>
  <div class="social-container">
    
      
        <a href="https://github.com/huopochuan" target="_blank">
          <i class="fab fa-github"></i>
        </a>
      
    
      
    
      
    
      
        <a href="https://www.zhihu.com/people/coderchuan" target="_blank">
          <i class="fab fa-zhihu"></i>
        </a>
      
    
      
    
  </div>
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
</div>


    </div>
    <script type="application/javascript">

hljs.initHighlightingOnLoad()

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>


  
  
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <script>

      var gitalk = new Gitalk({
        clientID: 'd8a2c3e875dce32a5a7f',
        clientSecret: '3007d9b48f166494b11f24dfc97fad0e42e4957c',
        repo: 'huopochuan.github.io',
        owner: 'huopochuan',
        admin: ['huopochuan'],
        id: location.pathname,      // Ensure uniqueness and length less than 50
        distractionFreeMode: false  // Facebook-like distraction free mode
      })

      gitalk.render('gitalk-container')

    </script>
  

  




  </body>
</html>
